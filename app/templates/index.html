{% extends "base.html" %}
{% import "bootstrap_wtf.html" as wtf %}

{% block content %}
    <h1>Hi, {{ current_user.username }}!</h1>

    {{ wtf.quick_form(form) }}

    {{ wtf.quick_form(filter_form) }}

    <table id="submissions" class="display">
        <thead>
            <tr>
                <th>#</th>
                <th>When</th>
                <th>Who</th>
                <th>Problem</th>
            </tr>
        </thead>
        <tbody>
            {% for post in posts %}
            <tr>
                <td><a>placeholder</a></td>
                <td>5 minutes ago</td>
                <td>{{post.author.username}}</td>
                <td>Problem ZZZ</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        // DataTable, wut dis?
        $('#submissions').DataTable();

        // we will change the value of the textarea through ACE
        function createEditor(id) {
            // find the textarea
            var textarea = document.querySelector("form textarea[id=" + id + "]");

            // create ace editor 
            var editor = ace.edit()
            editor.container.style.height = "300px"
            editor.session.setMode("ace/mode/python");
            editor.session.setValue(textarea.value)
            // replace textarea with ace
            textarea.parentNode.insertBefore(editor.container, textarea)
            textarea.style.display = "none"
            // find the parent form and add submit event listener
            var form = textarea
            while (form && form.localName != "form") form = form.parentNode
            form.addEventListener("submit", function() {
                // update value of textarea to match value in ace
                textarea.value = editor.getValue()
            }, true)
        }
        createEditor("post")

        // select form logic (i need a better way to filter)
        let my_select = document.getElementById("my");
        let onload = function() {
            let url = new URL(location.href);
            if (url.searchParams.get("my") == "on") {
                my_select.checked = true;
            }
        };
        onload();

        update = function() {
            let url = new URL(location.href);
            if (my_select.checked) {
                url.searchParams.set("my", "on");
            } else {
                url.searchParams.delete("my");
            }
            if (url.toString() != location.href) {
                location.href = url.toString();
            }
        };
        my_select.onchange = update;
    </script>

{% endblock %}
